{{ define "head-custom" }}
<!-- Pagefind CSS -->
<link href="/pagefind/pagefind-ui.css" rel="stylesheet">
{{ end }}

{{ define "main" }}
<!-- Breadcrumb -->
{{ partial "breadcrumb.html" . }}

<!-- Main Content -->
<main id="main-content" class="mx-auto w-full max-w-app px-4 pb-4" data-backurl="{{ .Permalink }}">
  <h1 class="text-2xl font-semibold sm:text-3xl">Search</h1>
  <p class="mt-2 mb-6 italic">Search any article ...</p>

  <!-- Pagefind Search Container with custom icon wrapper -->
  <div id="search-wrapper" class="relative">
    <!-- Pagefind Search Container -->
    <div id="pagefind-search"></div>

    <!-- Custom Search Icon (will be positioned over Pagefind's input) -->
    <svg id="custom-search-icon" class="absolute size-5 opacity-0 pointer-events-none transition-opacity"
      style="left: 1.5rem; top: 0;"
      width="20" height="20" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path
        d="M12.7549 11.255H11.9649L11.6849 10.985C12.6649 9.845 13.2549 8.365 13.2549 6.755C13.2549 3.165 10.3449 0.255005 6.75488 0.255005C3.16488 0.255005 0.254883 3.165 0.254883 6.755C0.254883 10.345 3.16488 13.255 6.75488 13.255C8.36488 13.255 9.84488 12.665 10.9849 11.685L11.2549 11.965V12.755L16.2549 17.745L17.7449 16.255L12.7549 11.255ZM6.75488 11.255C4.26488 11.255 2.25488 9.245 2.25488 6.755C2.25488 4.26501 4.26488 2.255 6.75488 2.255C9.24488 2.255 11.2549 4.26501 11.2549 6.755C11.2549 9.245 9.24488 11.255 6.75488 11.255Z"
        fill="currentColor" />
    </svg>
  </div>
</main>

<!-- Back URL tracking script -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const mainContent = document.querySelector("#main-content");
    const backUrl = mainContent?.dataset?.backurl;
    if (backUrl) {
      sessionStorage.setItem("backUrl", backUrl);
    }
  });
</script>

<!-- Pagefind Script -->
<script src="/pagefind/pagefind-ui.js" onerror="handlePagefindError()"></script>
<script>
  function handlePagefindError() {
    // Pagefind script failed to load - show dev warning
    const pageFindSearch = document.querySelector("#pagefind-search");
    if (pageFindSearch) {
      pageFindSearch.innerHTML = `
        <div class="rounded-lg border-2 border-accent/50 bg-accent/10 p-6 space-y-4">
          <div class="flex items-start gap-3">
            <svg class="size-6 text-accent flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div class="flex-1">
              <p class="font-semibold text-lg mb-2">DEV Mode Warning!</p>
              <p class="mb-3">You need to build the project at least once to see the search results during development.</p>
              <div class="bg-background/80 rounded p-3 font-mono text-sm">
                <code class="text-accent">pnpm run build</code>
              </div>
              <p class="mt-3 text-sm opacity-80">After building, you can use <code class="px-1.5 py-0.5 rounded bg-background/80 text-accent">pnpm dev</code> to continue development.</p>
            </div>
          </div>
        </div>
      `;
    }
  }

  (function () {
    function initSearch() {
      const pageFindSearch = document.querySelector("#pagefind-search");

      if (!pageFindSearch) return;

      const params = new URLSearchParams(window.location.search);

      // Check if we're in development mode (no pagefind files)
      fetch('/pagefind/pagefind.js')
        .then(response => {
          if (!response.ok) {
            // Development mode warning
            handlePagefindError();
            return;
          }

          // Init pagefind ui
          window.pagefind = new PagefindUI({
            element: "#pagefind-search",
            showSubResults: true,
            showImages: false,
            processTerm: function (term) {
              params.set("q", term);
              history.replaceState(history.state, "", "?" + params.toString());

              const backUrl = pageFindSearch?.dataset?.backurl;
              if (backUrl) {
                sessionStorage.setItem("backUrl", backUrl + "?" + params.toString());
              }

              return term;
            },
          });

          // If search param exists (eg: search?q=hugo), trigger search
          const query = params.get("q");
          if (query) {
            window.pagefind.triggerSearch(query);
          }

          // Reset search param if search input is cleared
          setTimeout(() => {
            const searchInput = document.querySelector(".pagefind-ui__search-input");
            const clearButton = document.querySelector(".pagefind-ui__search-clear");

            if (searchInput) {
              searchInput.addEventListener("input", resetSearchParam);
            }
            if (clearButton) {
              clearButton.addEventListener("click", resetSearchParam);
            }

            function resetSearchParam(e) {
              if (e.target?.value?.trim() === "") {
                history.replaceState(history.state, "", window.location.pathname);
              }
            }
          }, 100);
        })
        .catch(() => {
          // Development mode warning
          handlePagefindError();
        });
    }

    initSearch();

    // Position custom search icon correctly after Pagefind loads
    setTimeout(() => {
      const searchInput = document.querySelector('.pagefind-ui__search-input');
      const customIcon = document.getElementById('custom-search-icon');

      if (searchInput && customIcon) {
        // Calculate the vertical center of the input
        const inputRect = searchInput.getBoundingClientRect();
        const wrapperRect = document.getElementById('search-wrapper').getBoundingClientRect();
        const topOffset = (inputRect.top - wrapperRect.top) + (inputRect.height / 2) - 10; // 10 is half of icon height

        customIcon.style.top = `${topOffset}px`;
        customIcon.style.opacity = '0.7'; // Show icon after positioning
      }
    }, 200);
  })();
</script>

<style>
  #pagefind-search {
    --pagefind-ui-font: var(--font-mono);
    --pagefind-ui-text: var(--foreground);
    --pagefind-ui-background: var(--background);
    --pagefind-ui-border: var(--border);
    --pagefind-ui-primary: var(--accent);
    --pagefind-ui-tag: var(--background);
    --pagefind-ui-border-radius: 0.5rem;
    --pagefind-ui-border-width: 2px;
    --pagefind-ui-image-border-radius: 8px;
    --pagefind-ui-image-box-ratio: 3 / 2;
    --pagefind-ui-scale: 1;
  }

  /* Make sure the form container is positioned correctly */
  #pagefind-search form {
    position: relative;
  }

  /* Hide Pagefind's default search icon */
  #pagefind-search .pagefind-ui__form::before {
    display: none !important;
  }

  /* Custom search icon styling */
  #custom-search-icon {
    color: var(--foreground);
    z-index: 10;
  }

  /* Show icon more prominently when input is focused */
  #search-wrapper:has(.pagefind-ui__search-input:focus) #custom-search-icon {
    opacity: 1;
    color: var(--accent);
  }

  #pagefind-search input {
    font-weight: 400;
    font-size: 1rem;
    padding: 0.75rem 1rem 0.75rem 3rem !important;
    border: 2px solid var(--border) !important;
    background-color: var(--background) !important;
    color: var(--foreground) !important;
    box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
  }

  #pagefind-search input:hover {
    border-color: var(--accent) !important;
  }

  #pagefind-search input:focus,
  #pagefind-search input:focus-visible {
    outline: 2px solid var(--accent) !important;
    outline-offset: 2px;
    border-color: var(--accent) !important;
  }

  #pagefind-search .pagefind-ui__result-title a {
    color: var(--accent);
    outline-offset: 1px;
    outline-color: var(--accent);
  }

  #pagefind-search .pagefind-ui__result-title a:focus-visible,
  #pagefind-search .pagefind-ui__search-clear:focus-visible {
    text-decoration-line: none;
    outline-width: 2px;
    outline-style: dashed;
  }

  #pagefind-search .pagefind-ui__result:last-of-type {
    border-bottom: 0;
  }

  #pagefind-search .pagefind-ui__result-nested .pagefind-ui__result-link:before {
    font-family: system-ui;
  }
</style>
{{ end }}