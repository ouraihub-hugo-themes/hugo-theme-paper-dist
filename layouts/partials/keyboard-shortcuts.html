<!-- 快捷键支持 -->

<script>
  /**
   * 快捷键管理器
   * 支持全局快捷键操作
   */
  class KeyboardShortcutManager {
    constructor() {
      this.shortcuts = new Map();
      this.isOpen = false;
      this.init();
    }

    init() {
      this.registerShortcuts();
      this.setupEventListeners();
      this.createHelpDialog();
    }

    registerShortcuts() {
      // 搜索快捷键 (Cmd/Ctrl + K)
      this.addShortcut(['cmd_k', 'ctrl_k'], () => this.openSearch(), {
        description: 'Open search',
        global: true
      });

      // 主题切换快捷键 (Cmd/Ctrl + Shift + L)
      this.addShortcut(['cmd_shift_l', 'ctrl_shift_l'], () => this.toggleTheme(), {
        description: 'Toggle dark mode',
        global: true
      });

      // 返回顶部 (Home)
      this.addShortcut('home', () => this.scrollToTop(), {
        description: 'Scroll to top',
        global: true
      });

      // 返回底部 (End)
      this.addShortcut('end', () => this.scrollToBottom(), {
        description: 'Scroll to bottom',
        global: true
      });

      // 打开快捷键帮助 (?)
      this.addShortcut('?', () => this.toggleHelp(), {
        description: 'Show keyboard shortcuts',
        global: true
      });

      // 返回首页 (G + H)
      this.addShortcut(['g_h'], () => window.location.href = '/', {
        description: 'Go to homepage',
        global: true
      });

      // 返回归档页 (G + A)
      this.addShortcut(['g_a'], () => window.location.href = '/archives/', {
        description: 'Go to archives',
        global: true
      });
    }

    addShortcut(keys, callback, options = {}) {
      const keyArray = Array.isArray(keys) ? keys : [keys];
      keyArray.forEach(key => {
        this.shortcuts.set(key, {
          callback,
          description: options.description || '',
          global: options.global !== false
        });
      });
    }

    setupEventListeners() {
      let keysPressed = [];
      let lastKeyTime = 0;
      const KEY_TIMEOUT = 1500; // 1.5秒后重置

      document.addEventListener('keydown', (e) => {
        // 忽略输入框中的快捷键
        if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
          return;
        }

        const now = Date.now();
        if (now - lastKeyTime > KEY_TIMEOUT) {
          keysPressed = [];
        }
        lastKeyTime = now;

        // 构建快捷键字符串
        const keyStr = this.buildKeyString(e);
        keysPressed.push(keyStr);

        const combination = keysPressed.join('_');

        // 检查单个按键
        if (this.shortcuts.has(keyStr)) {
          e.preventDefault();
          const shortcut = this.shortcuts.get(keyStr);
          shortcut.callback();
          keysPressed = [];
        }

        // 检查组合键
        if (this.shortcuts.has(combination)) {
          e.preventDefault();
          const shortcut = this.shortcuts.get(combination);
          shortcut.callback();
          keysPressed = [];
        }
      });
    }

    buildKeyString(e) {
      const keys = [];

      if (e.ctrlKey) keys.push('ctrl');
      if (e.metaKey) keys.push('cmd');
      if (e.altKey) keys.push('alt');
      if (e.shiftKey) keys.push('shift');

      const keyMap = {
        'ArrowUp': 'up',
        'ArrowDown': 'down',
        'ArrowLeft': 'left',
        'ArrowRight': 'right',
        'Enter': 'enter',
        'Escape': 'esc',
        ' ': 'space',
        '?': '?'
      };

      const key = keyMap[e.key] || e.key.toLowerCase();
      if (key !== 'ctrl' && key !== 'cmd' && key !== 'alt' && key !== 'shift') {
        keys.push(key);
      }

      return keys.join('_');
    }

    openSearch() {
      const searchInput = document.querySelector('input[type="text"]');
      if (searchInput) {
        searchInput.focus();
      } else {
        // 如果没有搜索输入框，导航到搜索页面
        window.location.href = '/search/';
      }
    }

    toggleTheme() {
      const themeToggle = document.getElementById('theme-toggle');
      if (themeToggle) {
        themeToggle.click();
      }
    }

    scrollToTop() {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }

    scrollToBottom() {
      window.scrollTo({
        top: document.documentElement.scrollHeight,
        behavior: 'smooth'
      });
    }

    toggleHelp() {
      const helpDialog = document.getElementById('keyboard-shortcuts-dialog');
      if (helpDialog) {
        this.isOpen = !this.isOpen;
        if (this.isOpen) {
          helpDialog.classList.remove('hidden');
        } else {
          helpDialog.classList.add('hidden');
        }
      }
    }

    createHelpDialog() {
      const dialog = document.createElement('div');
      dialog.id = 'keyboard-shortcuts-dialog';
      dialog.className = 'fixed inset-0 z-50 hidden bg-black/50 flex items-center justify-center';

      const shortcuts = Array.from(this.shortcuts.entries())
        .filter(([_, s]) => s.global && s.description)
        .map(([keys, s]) => `
          <div class="flex justify-between items-center p-3 border-b border-border last:border-b-0">
            <span class="text-sm">${s.description}</span>
            <kbd class="px-2 py-1 rounded bg-muted text-foreground text-xs font-mono">${keys.replace(/_/g, ' + ').toUpperCase()}</kbd>
          </div>
        `).join('');

      dialog.innerHTML = `
        <div class="bg-background rounded-lg shadow-lg max-w-md w-full mx-4 max-h-96 overflow-y-auto">
          <div class="sticky top-0 p-4 border-b border-border bg-background flex justify-between items-center">
            <h3 class="text-lg font-bold">Keyboard Shortcuts</h3>
            <button onclick="document.getElementById('keyboard-shortcuts-dialog').classList.add('hidden')" class="text-muted hover:text-foreground">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          <div>${shortcuts}</div>
        </div>
      `;

      document.body.appendChild(dialog);

      // Esc关闭对话框
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !dialog.classList.contains('hidden')) {
          dialog.classList.add('hidden');
          this.isOpen = false;
        }
      });

      // 点击背景关闭
      dialog.addEventListener('click', (e) => {
        if (e.target === dialog) {
          dialog.classList.add('hidden');
          this.isOpen = false;
        }
      });
    }
  }

  // 初始化快捷键管理器
  new KeyboardShortcutManager();
</script>

<style>
  kbd {
    @apply px-2 py-1 rounded bg-muted text-foreground text-xs font-mono border border-border;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
</style>
