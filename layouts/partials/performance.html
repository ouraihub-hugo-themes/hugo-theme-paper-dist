<!-- Performance Optimization Script -->

<script>
  /**
   * Performance Optimization Manager
   * - Lazy loading for images
   * - Resource hints
   * - Performance monitoring
   */

  class PerformanceManager {
    constructor() {
      this.init();
    }

    init() {
      this.setupLazyLoading();
      this.setupResourceHints();
      this.monitorPerformance();
    }

    /**
     * Setup Intersection Observer for lazy loading
     */
    setupLazyLoading() {
      if ('IntersectionObserver' in window) {
        const images = document.querySelectorAll('img[loading="lazy"]');
        const observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              const img = entry.target;
              img.src = img.dataset.src || img.src;
              img.srcset = img.dataset.srcset || img.srcset || '';
              img.classList.remove('lazy');
              observer.unobserve(img);
            }
          });
        }, {
          rootMargin: '50px 0px',
          threshold: 0.01,
        });

        images.forEach((img) => observer.observe(img));
      }
    }

    /**
     * Add resource hints for critical resources
     */
    setupResourceHints() {
      const hints = [
        { rel: 'dns-prefetch', href: 'https://cdn.jsdelivr.net' },
        { rel: 'preconnect', href: 'https://fonts.googleapis.com' },
      ];

      hints.forEach(({ rel, href }) => {
        if (!document.querySelector(`link[rel="${rel}"][href="${href}"]`)) {
          const link = document.createElement('link');
          link.rel = rel;
          link.href = href;
          if (rel === 'preconnect') {
            link.crossOrigin = 'anonymous';
          }
          document.head.appendChild(link);
        }
      });
    }

    /**
     * Monitor and log performance metrics
     */
    monitorPerformance() {
      if ('PerformanceObserver' in window) {
        try {
          // Monitor Core Web Vitals
          const observer = new PerformanceObserver((list) => {
            for (const entry of list.getEntries()) {
              // Log metrics (in production, send to analytics)
              console.log(`${entry.name}: ${entry.value}`);
            }
          });

          observer.observe({ entryTypes: ['paint', 'largest-contentful-paint', 'layout-shift', 'first-input'] });
        } catch (e) {
          // Silently fail if not supported
        }
      }
    }

    /**
     * Prefetch next page on link hover
     */
    setupPrefetch() {
      const links = document.querySelectorAll('a[href^="/"]');
      links.forEach((link) => {
        link.addEventListener('mouseover', () => {
          const href = link.getAttribute('href');
          if (href && !document.querySelector(`link[rel="prefetch"][href="${href}"]`)) {
            const prefetch = document.createElement('link');
            prefetch.rel = 'prefetch';
            prefetch.href = href;
            document.head.appendChild(prefetch);
          }
        });
      });
    }

    /**
     * Get Web Vitals
     */
    getWebVitals() {
      const vitals = {
        lcp: 0,  // Largest Contentful Paint
        fid: 0,  // First Input Delay
        cls: 0,  // Cumulative Layout Shift
      };

      if ('PerformanceObserver' in window) {
        try {
          const observer = new PerformanceObserver((list) => {
            for (const entry of list.getEntries()) {
              if (entry.name === 'largest-contentful-paint') {
                vitals.lcp = entry.renderTime || entry.loadTime;
              }
            }
          });
          observer.observe({ type: 'largest-contentful-paint', buffered: true });
        } catch (e) {
          // Silently fail
        }
      }

      return vitals;
    }
  }

  // Initialize performance manager
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      new PerformanceManager();
    });
  } else {
    new PerformanceManager();
  }
</script>
