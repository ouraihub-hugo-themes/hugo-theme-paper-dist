<!-- æ–‡ç« ç‚¹èµåŠŸèƒ½ -->

<div class="post-like-container my-8 p-6 rounded-lg bg-muted/30 border border-border text-center">
  <button
    id="post-like-btn"
    class="inline-flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-medium transition-all duration-200"
    data-post-id="{{ .File.BaseFileName }}"
    data-post-title="{{ .Title }}"
  >
    <svg
      id="like-icon"
      class="w-5 h-5 transition-transform duration-300"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M14 10h-2m0 0H10m2 0v2m0-2v-2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"
      />
    </svg>
    <span id="like-text">Like This Post</span>
    <span id="like-count" class="text-sm">(0)</span>
  </button>

  <p id="like-message" class="text-sm text-muted mt-3 hidden"></p>
</div>

<script>
  /**
   * æ–‡ç« ç‚¹èµåŠŸèƒ½ç®¡ç†å™¨
   */
  class PostLikeManager {
    constructor() {
      this.btn = document.getElementById('post-like-btn');
      this.icon = document.getElementById('like-icon');
      this.text = document.getElementById('like-text');
      this.count = document.getElementById('like-count');
      this.message = document.getElementById('like-message');

      if (this.btn) {
        this.postId = this.btn.getAttribute('data-post-id');
        this.postTitle = this.btn.getAttribute('data-post-title');
        this.storageKey = `post-like-${this.postId}`;

        this.init();
      }
    }

    init() {
      // åŠ è½½ç‚¹èµæ•°æ®
      this.loadLikes();

      // ç»‘å®šç‚¹å‡»äº‹ä»¶
      this.btn.addEventListener('click', () => this.toggleLike());

      // ç›‘å¬ä¸»é¢˜åˆ‡æ¢
      const observer = new MutationObserver(() => this.updateIconColor());
      observer.observe(document.documentElement, { attributes: true });
    }

    loadLikes() {
      const likeData = this.getLikeData();
      this.updateUI(likeData);
    }

    toggleLike() {
      const likeData = this.getLikeData();
      likeData.liked = !likeData.liked;
      likeData.count += likeData.liked ? 1 : -1;
      likeData.timestamp = new Date().toISOString();

      // ä¿å­˜åˆ°localStorage
      localStorage.setItem(this.storageKey, JSON.stringify(likeData));

      // å°è¯•ä¿å­˜åˆ°æœåŠ¡å™¨ (å¯é€‰)
      this.syncToServer(likeData);

      // æ›´æ–°UI
      this.updateUI(likeData);

      // æ˜¾ç¤ºåé¦ˆæ¶ˆæ¯
      this.showMessage(likeData.liked);
    }

    getLikeData() {
      const data = localStorage.getItem(this.storageKey);
      if (data) {
        return JSON.parse(data);
      }
      return {
        postId: this.postId,
        postTitle: this.postTitle,
        liked: false,
        count: 0,
        timestamp: null
      };
    }

    updateUI(likeData) {
      // æ›´æ–°è®¡æ•°
      this.count.textContent = `(${likeData.count})`;

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      if (likeData.liked) {
        this.btn.classList.add('bg-accent', 'text-background');
        this.btn.classList.remove('bg-muted', 'hover:bg-accent');
        this.text.textContent = 'You Like This Post';
        this.updateIconColor();
      } else {
        this.btn.classList.remove('bg-accent', 'text-background');
        this.btn.classList.add('bg-muted', 'hover:bg-accent');
        this.text.textContent = 'Like This Post';
        this.updateIconColor();
      }
    }

    updateIconColor() {
      const theme = document.documentElement.getAttribute('data-theme') || 'light';
      // å›¾æ ‡é¢œè‰²æ ¹æ®æŒ‰é’®çŠ¶æ€è‡ªåŠ¨æ›´æ–°
    }

    showMessage(liked) {
      this.message.classList.remove('hidden');
      if (liked) {
        this.message.innerHTML = 'ğŸ’š Thanks for liking this post!';
        this.message.classList.add('text-accent');
      } else {
        this.message.innerHTML = 'ç‚¹èµå·²å–æ¶ˆ';
        this.message.classList.remove('text-accent');
      }

      // 3ç§’åéšè—æ¶ˆæ¯
      setTimeout(() => {
        this.message.classList.add('hidden');
      }, 3000);
    }

    syncToServer(likeData) {
      // å¯é€‰: å‘é€åˆ°æœåŠ¡å™¨ä¿å­˜
      // è¿™éœ€è¦åç«¯APIæ”¯æŒ
      // fetch('/api/likes', {
      //   method: 'POST',
      //   headers: { 'Content-Type': 'application/json' },
      //   body: JSON.stringify(likeData)
      // }).catch(err => console.log('Like sync failed:', err));
    }
  }

  // åˆå§‹åŒ–ç‚¹èµåŠŸèƒ½
  new PostLikeManager();
</script>

<style>
  .post-like-container button {
    @apply bg-muted text-foreground hover:bg-accent hover:text-background;
  }

  .post-like-container button.bg-accent {
    animation: scaleIn 0.3s ease-out;
  }

  @keyframes scaleIn {
    from {
      transform: scale(0.95);
      opacity: 0.7;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }
</style>
